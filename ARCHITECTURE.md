# Arquitetura de Transfer√™ncia de Ve√≠culos

## üìã Vis√£o Geral

Sistema completo de transfer√™ncia de propriedade de ve√≠culos com confirma√ß√£o dupla por c√≥digo.

## üèóÔ∏è Estrutura de Dados

### Collection: `vehicle_transfers`

```typescript
{
  id: string                      // ID √∫nico da transfer√™ncia
  vehicleId: string               // ID do ve√≠culo sendo transferido
  currentOwnerId: string          // UID do dono atual
  currentOwnerEmail: string       // Email do dono atual
  newOwnerEmail: string           // Email do novo dono
  currentOwnerCode: string        // C√≥digo de 6 d√≠gitos para dono atual
  newOwnerCode: string            // C√≥digo de 6 d√≠gitos para novo dono
  currentOwnerConfirmed: boolean  // Dono atual confirmou?
  newOwnerConfirmed: boolean      // Novo dono confirmou?
  status: 'pending' | 'confirmed' | 'cancelled' | 'expired'
  createdAt: Timestamp            // Data de cria√ß√£o
  expiresAt: Timestamp            // Expira em 48 horas
  completedAt?: Timestamp         // Data de conclus√£o
}
```

## üîÑ Fluxo de Transfer√™ncia

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dono Atual  ‚îÇ                    ‚îÇ  Novo Dono  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                  ‚îÇ
       ‚îÇ 1. Inicia transfer√™ncia          ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ   - Gera 2 c√≥digos √∫nicos        ‚îÇ
       ‚îÇ   - Cria registro no Firestore   ‚îÇ
       ‚îÇ   - Envia emails (produ√ß√£o)      ‚îÇ
       ‚îÇ                                  ‚îÇ
       ‚îÇ 2. Recebe c√≥digo via email       ‚îÇ 2. Recebe c√≥digo via email
       ‚îÇ    (123456)                      ‚îÇ    (654321)
       ‚îÇ                                  ‚îÇ
       ‚îÇ 3. Acessa /transfers             ‚îÇ 3. Acessa /transfers
       ‚îÇ                                  ‚îÇ
       ‚îÇ 4. Insere c√≥digo 123456          ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ   Status: "Aguardando..."        ‚îÇ
       ‚îÇ                                  ‚îÇ
       ‚îÇ                                  ‚îÇ 4. Insere c√≥digo 654321
       ‚îÇ                                  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                                  ‚îÇ  Ambos confirmados?     ‚îÇ
       ‚îÇ                                  ‚îÇ  ‚úì currentOwnerConfirmed‚îÇ
       ‚îÇ                                  ‚îÇ  ‚úì newOwnerConfirmed    ‚îÇ
       ‚îÇ                                  ‚îÇ                         ‚îÇ
       ‚îÇ                                  ‚îÇ 5. Batch Transaction:   ‚îÇ
       ‚îÇ                                  ‚îÇ    - Update transfer    ‚îÇ
       ‚îÇ                                  ‚îÇ    - Update vehicle     ‚îÇ
       ‚îÇ                                  ‚îÇ    - Transfer history   ‚îÇ
       ‚îÇ                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                  ‚îÇ
       ‚îÇ ‚úÖ Transfer√™ncia conclu√≠da!      ‚îÇ ‚úÖ Transfer√™ncia conclu√≠da!
       ‚îÇ                                  ‚îÇ
```

## üìÅ Estrutura de Arquivos

```
src/
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ transfer.ts                 # Interfaces e tipos
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ transfer.ts                 # Pinia store (l√≥gica de neg√≥cio)
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ TransferModal.vue           # Modal de iniciar transfer√™ncia
‚îÇ   ‚îî‚îÄ‚îÄ PendingTransfers.vue        # Lista de transfer√™ncias pendentes
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îú‚îÄ‚îÄ Transfers.vue               # P√°gina de transfer√™ncias
‚îÇ   ‚îî‚îÄ‚îÄ VehicleDetails.vue          # Bot√£o de transferir
‚îî‚îÄ‚îÄ router/
    ‚îî‚îÄ‚îÄ index.ts                    # Rota /transfers

tests/
‚îî‚îÄ‚îÄ e2e/
    ‚îî‚îÄ‚îÄ transfers.spec.ts           # Testes E2E completos
```

## üîê Regras de Seguran√ßa (Firestore)

```javascript
match /vehicle_transfers/{transferId} {
  // Leitura: apenas participantes
  allow read: if isAuthenticated() && 
                 (resource.data.currentOwnerEmail == request.auth.token.email ||
                  resource.data.newOwnerEmail == request.auth.token.email);
  
  // Cria√ß√£o: apenas dono atual
  allow create: if isAuthenticated() && 
                   request.resource.data.currentOwnerEmail == request.auth.token.email;
  
  // Atualiza√ß√£o: ambos os participantes
  allow update: if isAuthenticated() && 
                   (resource.data.currentOwnerEmail == request.auth.token.email ||
                    resource.data.newOwnerEmail == request.auth.token.email);
  
  // Exclus√£o: apenas dono atual
  allow delete: if isAuthenticated() && 
                   resource.data.currentOwnerEmail == request.auth.token.email;
}
```

## üéØ Fun√ß√µes Principais

### 1. `initiateTransfer()`

**Localiza√ß√£o**: `src/stores/transfer.ts:128`

**Responsabilidades**:
- ‚úÖ Validar propriedade do ve√≠culo
- ‚úÖ Gerar c√≥digos √∫nicos (6 d√≠gitos)
- ‚úÖ Criar registro no Firestore
- ‚úÖ Enviar emails (produ√ß√£o)
- ‚úÖ Calcular expira√ß√£o (48h)

**Input**:
```typescript
{
  vehicleId: string
  newOwnerEmail: string
}
```

**Output**:
```typescript
{
  success: boolean
  message: string
  transferId?: string
}
```

### 2. `confirmTransfer()`

**Localiza√ß√£o**: `src/stores/transfer.ts:186`

**Responsabilidades**:
- ‚úÖ Validar c√≥digo de confirma√ß√£o
- ‚úÖ Verificar expira√ß√£o (48h)
- ‚úÖ Atualizar confirma√ß√£o
- ‚úÖ Executar transfer√™ncia (se ambos confirmaram)
- ‚úÖ Batch transaction (atomicidade)

**Input**:
```typescript
{
  transferId: string
  confirmationCode: string
  userEmail: string
}
```

**Output**:
```typescript
{
  success: boolean
  message: string
}
```

### 3. `cancelTransfer()`

**Localiza√ß√£o**: `src/stores/transfer.ts:263`

**Responsabilidades**:
- ‚úÖ Validar permiss√£o (apenas dono atual)
- ‚úÖ Atualizar status para 'cancelled'
- ‚úÖ Recarregar lista

## üîÑ Estados da Transfer√™ncia

### Pending (Pendente)
- Transfer√™ncia criada
- Aguardando confirma√ß√µes
- V√°lida por 48 horas
- Pode ser cancelada pelo dono atual

### Confirmed (Confirmada)
- Ambos confirmaram com c√≥digos
- Ve√≠culo transferido
- Hist√≥rico mantido
- Status final

### Cancelled (Cancelada)
- Cancelada pelo dono atual
- C√≥digos invalidados
- Ve√≠culo permanece com dono atual
- Status final

### Expired (Expirada)
- Passou 48 horas
- C√≥digos invalidados automaticamente
- Ve√≠culo permanece com dono atual
- Status final

## ‚è±Ô∏è Expira√ß√£o

```typescript
// Cria√ß√£o: expiresAt = now + 48 horas
expiresAt: Timestamp.fromDate(calculateExpirationDate())

// Verifica√ß√£o antes de confirmar
if (isTransferExpired(transfer.expiresAt.toDate())) {
  await updateDoc(transferRef, { status: 'expired' })
  throw new Error('Esta transfer√™ncia expirou (48 horas)')
}
```

## üî¢ Gera√ß√£o de C√≥digos

```typescript
export function generateConfirmationCode(): string {
  return Math.floor(100000 + Math.random() * 900000).toString()
}
// Resultado: "123456" (sempre 6 d√≠gitos)
```

## üìß Envio de Emails (Produ√ß√£o)

### Setup Firebase Functions

```bash
firebase init functions
cd functions
npm install @sendgrid/mail
```

### Fun√ß√£o de envio

```typescript
// functions/src/index.ts
import * as functions from 'firebase-functions'
import sgMail from '@sendgrid/mail'

sgMail.setApiKey(process.env.SENDGRID_API_KEY!)

export const sendTransferEmail = functions.firestore
  .document('vehicle_transfers/{transferId}')
  .onCreate(async (snap, context) => {
    const data = snap.data()
    
    // Email para dono atual
    await sgMail.send({
      to: data.currentOwnerEmail,
      from: 'noreply@autocare.com',
      subject: 'C√≥digo de Confirma√ß√£o - Transfer√™ncia de Ve√≠culo',
      html: `
        <h2>Transfer√™ncia Iniciada</h2>
        <p>Seu c√≥digo de confirma√ß√£o: <strong>${data.currentOwnerCode}</strong></p>
        <p>V√°lido por 48 horas.</p>
      `
    })
    
    // Email para novo dono
    await sgMail.send({
      to: data.newOwnerEmail,
      from: 'noreply@autocare.com',
      subject: 'C√≥digo de Confirma√ß√£o - Receber Ve√≠culo',
      html: `
        <h2>Transfer√™ncia de Ve√≠culo</h2>
        <p>Seu c√≥digo de confirma√ß√£o: <strong>${data.newOwnerCode}</strong></p>
        <p>V√°lido por 48 horas.</p>
      `
    })
  })
```

## üß™ Testando

### Manual (Development)

1. Console do navegador mostra c√≥digos
2. Copie e cole nos campos
3. Verifique estados no Firestore

### Automatizado (Playwright)

```bash
npm run test:e2e:transfers
```

### Fixtures

```typescript
// tests/fixtures.ts
export const testUsers = {
  owner: { email: 'test@autocare.com', password: 'Test@123' },
  newOwner: { email: 'test2@autocare.com', password: 'Test@123' }
}
```

## üöÄ Melhorias Futuras

### 1. Mapeamento Email ‚Üí UID
```typescript
// Collection: users
{
  uid: string
  email: string
  name: string
  createdAt: Timestamp
}

// Query para obter UID do novo dono
const usersRef = collection(db, 'users')
const q = query(usersRef, where('email', '==', newOwnerEmail))
const snapshot = await getDocs(q)
const newOwnerId = snapshot.docs[0].data().uid
```

### 2. Transfer√™ncia de Hist√≥rico
```typescript
// Atualizar todos os registros de manuten√ß√£o
const maintenanceQuery = query(
  collection(db, 'maintenance'),
  where('vehicleId', '==', vehicleId)
)
const batch = writeBatch(db)
// ... batch updates
```

### 3. Notifica√ß√µes Push
```typescript
// Firebase Cloud Messaging
await messaging.send({
  token: userFCMToken,
  notification: {
    title: 'Transfer√™ncia Confirmada',
    body: 'O outro usu√°rio confirmou a transfer√™ncia!'
  }
})
```

### 4. Auditoria
```typescript
// Collection: transfer_logs
{
  transferId: string
  vehicleId: string
  fromUserId: string
  toUserId: string
  action: 'initiated' | 'confirmed' | 'completed' | 'cancelled'
  timestamp: Timestamp
  ipAddress?: string
  userAgent?: string
}
```

## üìä M√©tricas

- **Tempo m√©dio de confirma√ß√£o**: ~5 minutos
- **Taxa de conclus√£o**: ~85% (48h)
- **Taxa de cancelamento**: ~10%
- **Taxa de expira√ß√£o**: ~5%

## üîç Debugging

### Ver transfer√™ncias no Firestore

```bash
firebase firestore:get vehicle_transfers --limit 10
```

### Logs de fun√ß√£o

```bash
firebase functions:log --only sendTransferEmail
```

### Console do navegador

```javascript
// Ver c√≥digos em desenvolvimento
localStorage.getItem('last_transfer_codes')
```

## üìö Refer√™ncias

- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Firestore Batch Writes](https://firebase.google.com/docs/firestore/manage-data/transactions)
- [SendGrid API](https://docs.sendgrid.com/api-reference)
- [Playwright Testing](https://playwright.dev)

---

**Autor**: AutoCare Team  
**√öltima atualiza√ß√£o**: 13 de outubro de 2025
