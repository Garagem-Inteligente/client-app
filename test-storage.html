<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Firebase Storage</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    .test-section {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #2563eb; }
    input[type="file"] {
      margin: 10px 0;
      padding: 10px;
      background: #3a3a3a;
      border: 1px solid #4a4a4a;
      border-radius: 4px;
      color: white;
    }
    #log {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4a4a4a;
      padding-left: 10px;
    }
  </style>
</head>
<body>
  <h1>üî• Firebase Storage Test</h1>
  
  <div class="test-section">
    <h2>1. Configuration Check</h2>
    <button onclick="testConfig()">Check Firebase Config</button>
    <p id="config-status"></p>
  </div>

  <div class="test-section">
    <h2>2. Authentication Test</h2>
    <button onclick="testAuth()">Test Auth State</button>
    <p id="auth-status"></p>
  </div>

  <div class="test-section">
    <h2>3. Upload Test</h2>
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="testUpload()">Upload Test Image</button>
    <p id="upload-status"></p>
    <img id="uploadedImage" style="max-width: 200px; display: none; margin-top: 10px;">
  </div>

  <div class="test-section">
    <h2>üìã Log</h2>
    <div id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js'

    // Load from .env (you'll need to paste your config here)
    const firebaseConfig = {
      apiKey: "AIzaSyDtwoXZUnHSgUg_Rr0-BSgrNchn6hk9UgU",
      authDomain: "autocare-platform.firebaseapp.com",
      projectId: "autocare-platform",
      storageBucket: "autocare-platform.firebasestorage.app",
      messagingSenderId: "868408826724",
      appId: "1:868408826724:web:37775191fb1e4b26d57871",
      measurementId: "G-TVZFYH3Z0M"
    }

    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const storage = getStorage(app)

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    window.testConfig = () => {
      const status = document.getElementById('config-status')
      log('Testing Firebase configuration...', 'info')
      
      if (firebaseConfig.storageBucket) {
        status.innerHTML = `<span class="success">‚úÖ Storage Bucket: ${firebaseConfig.storageBucket}</span>`
        log(`‚úÖ Storage bucket configured: ${firebaseConfig.storageBucket}`, 'success')
      } else {
        status.innerHTML = '<span class="error">‚ùå No storage bucket configured</span>'
        log('‚ùå Storage bucket not found', 'error')
      }
    }

    window.testAuth = () => {
      const status = document.getElementById('auth-status')
      log('Checking auth state...', 'info')
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          status.innerHTML = `<span class="success">‚úÖ Authenticated as: ${user.email}</span>`
          log(`‚úÖ User authenticated: ${user.email}`, 'success')
        } else {
          status.innerHTML = '<span class="warning">‚ö†Ô∏è Not authenticated. Please login in the app first.</span>'
          log('‚ö†Ô∏è User not authenticated', 'warning')
        }
      })
    }

    window.testUpload = async () => {
      const fileInput = document.getElementById('fileInput')
      const status = document.getElementById('upload-status')
      const img = document.getElementById('uploadedImage')
      
      if (!fileInput.files[0]) {
        status.innerHTML = '<span class="error">‚ùå Please select a file first</span>'
        log('‚ùå No file selected', 'error')
        return
      }

      const user = auth.currentUser
      if (!user) {
        status.innerHTML = '<span class="error">‚ùå Please login first</span>'
        log('‚ùå User not authenticated', 'error')
        return
      }

      try {
        log('üì§ Starting upload test...', 'info')
        const file = fileInput.files[0]
        const timestamp = Date.now()
        const path = `vehicles/${user.uid}/test-vehicle/test_${timestamp}.jpg`
        
        log(`üì¶ File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info')
        log(`üìç Path: ${path}`, 'info')
        
        const storageRef = ref(storage, path)
        const snapshot = await uploadBytes(storageRef, file)
        
        log('‚úÖ Upload completed!', 'success')
        
        const downloadURL = await getDownloadURL(snapshot.ref)
        log(`üîó URL: ${downloadURL.substring(0, 80)}...`, 'success')
        
        status.innerHTML = `<span class="success">‚úÖ Upload successful!</span>`
        img.src = downloadURL
        img.style.display = 'block'
        
      } catch (error) {
        status.innerHTML = `<span class="error">‚ùå Upload failed: ${error.message}</span>`
        log(`‚ùå Upload error: ${error.message}`, 'error')
        log(`Error code: ${error.code}`, 'error')
      }
    }

    // Auto-run config test
    window.addEventListener('load', () => {
      log('üî• Firebase Storage Test initialized', 'info')
      testConfig()
      testAuth()
    })
  </script>
</body>
</html>
